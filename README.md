```markdown
# Codon Optimization (Оптимизация Кодонов)

Этот проект реализует скрипт для оптимизации кодонов с использованием меметического алгоритма. Код адаптирован для работы как через консоль, так и через Jupyter Notebook, включая поддержку Google Colab. Проект включает установку зависимостей, запуск оптимизации и тестирование.

## Описание проекта

Скрипт оптимизирует ДНК-последовательности для заданных аминокислотных последовательностей, используя следующие критерии:

*   **Codon Usage (CAI):** Оптимизация использования кодонов для *E. coli* K-12 MG1655.
*   **GC Content:** Поддержание GC-содержания в заданном диапазоне.
*   **Avoid Pattern:** Исключение нежелательных мотивов (паттернов).
*   **RBS Specification:** Оптимизация расположения сайта связывания рибосомы (Shine-Dalgarno).
*   **RNA Folding:** Оптимизация стабильности вторичной структуры мРНК (требуется установленный **ViennaRNA**).
*   **Codon Pair Bias (CPB):** Оптимизация парного использования кодонов (codon pair usage).

Оптимизация выполняется с помощью **меметического алгоритма**, который сочетает генетический алгоритм с локальным поиском для улучшения решений.

## Этапы работы (История изменений)

1.  **Исправление ошибок:**
    *   Исправлена ошибка с отсутствием атрибута `num_processes` в классе `CodonOptimizer`.
    *   Добавлена поддержка **Entrez** для загрузки данных о кодонах (требуется указание `email`).
    *   Включена поддержка **ViennaRNA** для анализа свертки мРНК.

2.  **Оптимизация производительности:**
    *   Уменьшены параметры меметического алгоритма для ускорения (особенно на ограниченных ресурсах):
        *   `population_size`: 20 → 10
        *   `num_generations`: 10 → 5
        *   `local_search_steps`: 5 → 3
        *   `mutation_rate`: 0.04 → 0.06 (небольшое увеличение для исследования пространства)
    *   Оптимизировано кэширование с помощью **LRU-кэша** (увеличен размер до 50,000 записей).
    *   Добавлен механизм **сохранения разнообразия** в меметическом алгоритме для предотвращения преждевременной сходимости к локальным минимумам.
    *   Локальный поиск **отключен** для последовательностей короче 10 аминокислот (где его влияние невелико).

3.  **Добавление функциональности:**
    *   Добавлен **мониторинг использования ресурсов** (CPU, память) во время оптимизации.
    *   Реализована **автоматическая загрузка** FASTA файла для *E. coli* K-12 MG1655 при первом запуске, если файл отсутствует.
    *   Обеспечена поддержка **всех спецификаций** оптимизации, включая `RnaFolding` и `CodonPairBias`.

## Результаты

Ниже приведены результаты оптимизации для тестовых последовательностей (пример последнего запуска):

| Последовательность     | Длина (aa) | Приспособленность | Время (с) | GC Content | CAI    |
|------------------------|------------|-------------------|-----------|------------|--------|
| ShortPeptide           | 6          | 3.5395            | 17.88     | 0.556      | 0.8688 |
| HemoglobinSubunit      | 60         | 3.6657            | 335.51    | 0.556      | 0.9740 |
| HypotheticalProtein1 | 74         | 3.7000            | 315.63    | 0.550      | 1.0000 |
| HypotheticalProtein2 | 163        | 3.5424            | 709.67    | 0.540      | 0.8687 |
| GFP                    | 238        | 3.5587            | 887.69    | 0.479      | 0.8822 |

*   Максимальная теоретическая приспособленность (без учета CPB): ~3.2.
*   Достигнутая приспособленность: ~85–88% от максимума (включая CPB и другие факторы, влияющие на финальную оценку).

## Улучшения и Рекомендации

*   Время выполнения может быть значительным, особенно для длинных последовательностей и при включении `RnaFolding`. Время выполнения на Google Colab может быть выше из-за ограничений ресурсов.
*   Для достижения лучшей производительности и ускорения оптимизации рекомендуется запускать скрипт на **локальной машине** с достаточными ресурсами CPU и RAM.

## Установка

### Требования

*   Python 3.8+
*   Системные зависимости: `viennarna` (для спецификации `RnaFolding`)

### Установка через pip

1.  Клонируйте репозиторий (замените `yourusername` на ваше имя пользователя):
    ```bash
    git clone https://github.com/yourusername/codon-optimization.git
    cd codon-optimization
    ```
2.  Установите зависимости Python:
    ```bash
    pip install -r requirements.txt
    ```
3.  (Для Linux) Установите ViennaRNA:
    ```bash
    sudo apt-get update && sudo apt-get install -y viennarna
    ```
    *(Примечание: Для macOS используйте `brew install viennarna`. Для Windows может потребоваться ручная установка или использование WSL/Conda).*

### Установка через conda

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/yourusername/codon-optimization.git
    cd codon-optimization
    ```
2.  Создайте и активируйте окружение Conda (включая `viennarna` из канала `bioconda`):
    ```bash
    conda env create -f environment.yml
    conda activate codon_optimization
    ```

### Для Google Colab

1.  Клонируйте репозиторий в ячейке Colab:
    ```python
    !git clone https://github.com/yourusername/codon-optimization.git
    %cd codon-optimization
    ```
2.  Установите системные и Python зависимости:
    ```python
    !apt-get update && apt-get install -y viennarna
    !pip install -r requirements.txt
    ```
3.  Откройте ноутбук `src/run_notebook.ipynb` и следуйте инструкциям внутри него.

## Использование

### Запуск через консоль

1.  **Важно:** Установите переменную окружения с вашим email для **Entrez NCBI** (требуется для скачивания данных):
    ```bash
    export ENTREZ_EMAIL="your_email@example.com" 
    ```
    *(Замените `your_email@example.com` на ваш реальный email)*
2.  Запустите основной скрипт оптимизации:
    ```bash
    python run.py
    ```
3.  Результаты (оптимизированные последовательности, логи, графики) будут сохранены в папке `optimization_results/`.

### Запуск через Jupyter Notebook

1.  Установите Jupyter (если еще не установлен):
    ```bash
    pip install jupyterlab notebook
    ```
2.  Запустите Jupyter Notebook или JupyterLab:
    ```bash
    jupyter notebook
    # или
    jupyter lab
    ```
3.  Откройте `src/run_notebook.ipynb`. Установите ваш email для Entrez в соответствующей ячейке ноутбука и выполните все ячейки для запуска оптимизации.

## Запуск тестов

Для проверки корректности работы основных компонентов выполните:

```bash
python -m unittest src/tests.py
```

## Примеры результатов

Пример вывода лога для короткой последовательности (`ShortPeptide`):

```
2025-04-22 23:31:01,766 - INFO - --- Оптимизация завершена ---
CodonUsage оценка: 0.8688
GC Content оценка: 0.6265
Оптимизированная ДНК: ATGGCAGGTTGGTCTCGT
Приспособленность: 3.5395, GC: 0.556, CAI: 0.8688
```

Графики, показывающие динамику метрик (приспособленность, GC%, CAI) в процессе оптимизации, сохраняются в папке `optimization_results/` для каждой оптимизированной последовательности.

*(Пример графика для ShortPeptide должен быть показан здесь, если возможно вставить изображение, или дана ссылка на файл)*

## Дополнительная информация

*   **`data/`**: Директория предназначена для хранения данных, таких как загруженный FASTA файл генома *E. coli* K-12 MG1655, таблицы использования кодонов и т.д.
*   **`optimization_results/`**: В этой директории сохраняются все результаты запусков: оптимизированные последовательности (например, в формате FASTA), файлы логов и графики метрик.
*   Для улучшения производительности на Google Colab можно дополнительно **уменьшить параметры алгоритма** (`population_size`, `num_generations`) или оптимизировать только по подмножеству критериев.

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл `LICENSE` для получения подробной информации.
```
